<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>ZPL Converter + Preview</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="./zpl-converter.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      .left,
      .right {
        padding: 20px;
        overflow-y: auto;
      }

      .left {
        width: 40%;
        background-color: #f5f5f5;
        border-right: 1px solid #ccc;
      }

      .right {
        width: 60%;
        background-color: #fff;
      }

      h2,
      h3 {
        margin-top: 0;
      }

      label {
        display: block;
        margin-top: 10px;
        font-size: 14px;
      }

      input[type="number"],
      select,
      textarea {
        width: 100%;
        margin-top: 4px;
        padding: 5px;
        font-size: 14px;
      }

      textarea {
        margin-top: 10px;
        resize: vertical;
      }

      .preview-wrapper {
        position: relative;
        margin-top: 10px;
        border: 2px dashed gray;
        background-color: #fafafa;
        padding: 20px;
        display: inline-block;
      }

      .ruler {
        position: absolute;
        pointer-events: none;
        font-size: 10px;
        color: #555;
      }

      .ruler.horizontal {
        top: -20px;
        left: 0;
        right: 0;
        height: 20px;
        display: flex;
        justify-content: space-between;
      }

      .ruler.vertical {
        top: 0;
        left: -25px;
        bottom: 0;
        width: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      #zplPreview {
        display: block;
        background-color: white;
        max-width: 100%;
      }
    </style>
  </head>

  <body>
    <div class="left">
      <h2>ZPL Converter</h2>
      <input type="file" id="imageInput" accept="image/*" />

      <label
        >ความกว้าง (cm):
        <input
          type="number"
          id="width"
          value="8"
          step="0.1"
          oninput="convertImage()"
        />
      </label>

      <label
        >ความสูง (cm):
        <input
          type="number"
          id="height"
          value="4.5"
          step="0.1"
          oninput="convertImage()"
        />
      </label>

      <label
        >รูปแบบ:
        <select id="format" onchange="convertImage()">
          <option value="ACS">ACS</option>
          <option value="Z64">Z64</option>
        </select>
      </label>

      <label
        >การหมุน:
        <select id="rotation" onchange="convertImage()">
          <option value="N">ไม่มี</option>
          <option value="R">ขวา 90°</option>
          <option value="L">ซ้าย 90°</option>
          <option value="I">กลับหัว</option>
        </select>
      </label>

      <label
        >ระดับความดำ (1–99):
        <input
          type="number"
          id="blackThreshold"
          value="50"
          min="1"
          max="99"
          oninput="convertImage()"
        />
      </label>

      <label
        >ความเข้ม (0–100):
        <input
          type="number"
          id="darkness"
          value="70"
          min="0"
          max="100"
          oninput="convertImage()"
        />
      </label>

      <label
        >ไม่ตัดขอบ (noTrim):
        <input type="checkbox" id="noTrim" checked onchange="convertImage()" />
      </label>

      <h3>ZPL Output</h3>
      <textarea id="zplOutput" rows="8"></textarea>
    </div>

    <div class="right">
      <h2>Preview ZPL (Labelary)</h2>
      <div id="previewContainer" class="preview-wrapper">
        <div id="rulerH" class="ruler horizontal"></div>
        <div id="rulerV" class="ruler vertical"></div>
        <img id="zplPreview" alt="ZPL Preview" />
      </div>
    </div>

    <script>
      let base64ImageData = null;

      document.getElementById("imageInput").addEventListener("change", () => {
        const file = document.getElementById("imageInput").files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          base64ImageData = e.target.result;
          convertImage();
        };
        reader.readAsDataURL(file);
      });

      async function convertImage() {
        const zplOutput = document.getElementById("zplOutput");
        const zplPreview = document.getElementById("zplPreview");
        const rulerH = document.getElementById("rulerH");
        const rulerV = document.getElementById("rulerV");

        if (!base64ImageData) return;

        const options = {
          width: parseFloat(document.getElementById("width").value),
          height: parseFloat(document.getElementById("height").value),
          format: document.getElementById("format").value,
          rotation: document.getElementById("rotation").value,
          blackThreshold: parseInt(
            document.getElementById("blackThreshold").value
          ),
          darkness: parseInt(document.getElementById("darkness").value),
          noTrim: document.getElementById("noTrim").checked,
        };

        try {
          const zplCode = await convertToZPL(base64ImageData, options);
          zplOutput.value = zplCode;

          const inchesWidth = options.width / 2.54;
          const inchesHeight = options.height / 2.54;
          const url = `https://api.labelary.com/v1/printers/8dpmm/labels/${inchesWidth}x${inchesHeight}/0/`;

          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: zplCode,
          });

          if (!response.ok) throw new Error("ZPL render failed");

          const blob = await response.blob();
          zplPreview.src = URL.createObjectURL(blob);

          // update ruler ticks
          updateRulers(options.width, options.height);
        } catch (error) {
          console.error("แปลงภาพหรือแสดง preview ไม่สำเร็จ:", error);
        }
      }

      function updateRulers(widthCm, heightCm) {
        const rulerH = document.getElementById("rulerH");
        const rulerV = document.getElementById("rulerV");

        rulerH.innerHTML = "";
        rulerV.innerHTML = "";

        for (let i = 0; i <= widthCm; i++) {
          const tick = document.createElement("div");
          tick.innerText = i + "cm";
          tick.style.flex = "1";
          tick.style.textAlign = "center";
          rulerH.appendChild(tick);
        }

        for (let i = 0; i <= heightCm; i++) {
          const tick = document.createElement("div");
          tick.innerText = i + "cm";
          tick.style.flex = "1";
          tick.style.writingMode = "vertical-rl";
          tick.style.textAlign = "center";
          rulerV.appendChild(tick);
        }
      }
    </script>
  </body>
</html>
