<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Convert images to Zebra ZPL label format online. Preview and download ZPL code for Zebra printers."
    />
    <meta
      name="keywords"
      content="ZPL converter, Zebra label, image to ZPL, label printer, ZPL code generator"
    />
    <title>ZPL Converter – Convert Images to Zebra ZPL</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <script src="./dict/zpl-converter.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        height: 100vh;
        width: 100vw;
        overflow: hidden;
      }

      .left,
      .right {
        padding: 20px;
        overflow-y: auto;
      }

      .left {
        width: 40%;
        background-color: #eee;
        border-right: 1px solid #000;
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .right {
        width: 60%;
        background-color: #fff;
        display: flex;
        flex-direction: column;
      }

      h2,
      h3 {
        margin: 0 0 15px 0;
      }

      label {
        font-size: 14px;
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .label-checkbox {
        font-size: 14px;
        display: inline !important;
        gap: 4px;
      }

      input[type="number"],
      select {
        width: 100%;
        padding: 2px;
        font-size: 14px;
        border: 1px solid #000;
        border-radius: 0;
        background-color: #fff;
        -webkit-appearance: menulist;
        -moz-appearance: menulist;
        appearance: menulist;
      }

      input[type="checkbox"] {
        margin-right: 5px;
      }

      .preview-wrapper {
        margin-top: 10px;
        border: 1px solid black;
        background-color: #fff;
        padding: 20px;
        display: inline-block;
        position: relative;
      }

      .ruler {
        position: absolute;
        pointer-events: none;
        font-size: 10px;
        color: #555;
      }

      .ruler.horizontal {
        top: -20px;
        left: 0;
        right: 0;
        height: 20px;
        display: flex;
        justify-content: space-between;
      }

      .ruler.vertical {
        top: 0;
        left: -25px;
        bottom: 0;
        width: 20px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      #zplPreview {
        display: block;
        background-color: white;
        max-width: 100%;
      }

      .download-link {
        position: sticky;
        bottom: 20px;
        margin-top: 15px;
        display: inline-block;
        background-color: #808080;
        color: white;
        padding: 5px 10px;
        text-decoration: none;
        border: 2px outset #c0c0c0;
        font-size: 14px;
        text-align: center;
        font-family: Arial, sans-serif;
      }

      .download-link:hover {
        background-color: #606060;
      }

      .download-link:active {
        border-style: inset;
      }

      .placeholder {
        color: #000;
        text-align: center;
        padding: 40px 0;
        font-family: "Times New Roman", Times, serif;
      }

      .hidden {
        display: none;
      }
      .code-example {
        background-color: #f8f8f8;
        border-radius: 8px;
        font-size: 13px;
        border: 1px solid #e0e0e0;
        line-height: 1.6;
        padding: 16px;
        color: #333;
        white-space: pre-wrap;
        word-break: break-word;
        overflow-x: hidden;
      }

      .code-example .comment {
        color: #6a9955;
        font-style: italic;
      }
      .code-example .keyword {
        color: #569cd6;
        font-weight: bold;
      }
      .code-example .string {
        color: #ce9178;
      }
      .code-example .number {
        color: #b5cea8;
      }

      .section {
        margin-bottom: 15px;
      }

      .output-section {
        margin-top: 20px;
      }

      #output {
        width: 100%;
        max-width: 100%;
        box-sizing: border-box;
        font-family: "Courier New", Courier, monospace;
        white-space: pre;
        overflow-wrap: break-word;
        overflow-x: auto;
        resize: vertical;
        padding: 5px;
        margin-top: 10px;
        background-color: #fff;
        color: #000;
      }
    </style>
  </head>

  <body>
    <div class="left">
      <div class="section">
        <h2>ZPL Converter</h2>
      </div>

      <div class="section">
        <input type="file" id="imageInput" accept="image/*" />
      </div>

      <div class="section">
        <label>
          Width (cm):
          <input
            type="number"
            id="width"
            value="8"
            step="0.1"
            oninput="convertImage()"
          />
        </label>
      </div>

      <div class="section">
        <label>
          Height (cm):
          <input
            type="number"
            id="height"
            value="4.5"
            step="0.1"
            oninput="convertImage()"
          />
        </label>
      </div>

      <div class="section">
        <label>
          Format:
          <select id="format" onchange="convertImage()">
            <option value="ACS">ACS</option>
            <option value="Z64">Z64</option>
          </select>
        </label>
      </div>

      <div class="section">
        <label>
          Rotation:
          <select id="rotation" onchange="convertImage()">
            <option value="N">None</option>
            <option value="R">Right 90°</option>
            <option value="L">Left 90°</option>
            <option value="I">Inverted</option>
          </select>
        </label>
      </div>

      <div class="section">
        <label>
          Black Threshold (1–99):
          <input
            type="number"
            id="blackThreshold"
            value="50"
            min="1"
            max="99"
            oninput="convertImage()"
          />
        </label>
      </div>

      <div class="section">
        <label>
          Darkness (0–100):
          <input
            type="number"
            id="darkness"
            value="70"
            min="0"
            max="100"
            oninput="convertImage()"
          />
        </label>
      </div>

      <div class="section">
        <input
          type="checkbox"
          id="noTrim"
          name="noTrim"
          checked
          onchange="convertImage()"
        />
        <label class="label-checkbox" for="noTrim"
          >Don't trim edges (noTrim)</label
        >
      </div>

      <div class="section">
        <a href="./zpl-converter.js" download class="download-link"
          >⬇️ Download zpl-converter.js</a
        >
      </div>
      <div class="section">
        <h3>How to Use</h3>
        <pre class="code-example"><code>
          <span class="comment">// Import pako for compression (if needed)</span>
          &lt;script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"&gt;&lt;/script&gt;
          
          <span class="comment">// Basic usage example</span>
          <span class="keyword">const</span> zplCode = <span class="keyword">await</span> convertToZPL(imageData, {
            width: <span class="number">8</span>,        <span class="comment">// cm</span>
            height: <span class="number">4.5</span>,     <span class="comment">// cm</span>
            format: <span class="string">'ACS'</span>,   <span class="comment">// or 'Z64'</span>
            rotation: <span class="string">'N'</span>,   <span class="comment">// N, R, L, or I</span>
            blackThreshold: <span class="number">50</span>,
            darkness: <span class="number">70</span>,
            noTrim: <span class="keyword">true</span>
          });
          </code></pre>
      </div>
    </div>

    <div class="right">
      <div class="section">
        <h2>ZPL Preview (Labelary)</h2>
      </div>

      <div class="preview-section">
        <div id="previewContainer" class="preview-wrapper">
          <div id="rulerH" class="ruler horizontal hidden"></div>
          <div id="rulerV" class="ruler vertical hidden"></div>
          <div id="previewPlaceholder" class="placeholder">
            Preview will appear here after conversion
          </div>
          <img id="zplPreview" class="hidden" alt="ZPL Preview" />
        </div>
      </div>

      <div class="output-section">
        <h3>ZPL Output</h3>
        <textarea id="output" rows="5" readonly></textarea>
      </div>
    </div>

    <script>
      let base64ImageData = null;
      const zplPreview = document.getElementById("zplPreview");
      const previewPlaceholder = document.getElementById("previewPlaceholder");
      const rulerH = document.getElementById("rulerH");
      const rulerV = document.getElementById("rulerV");
      const output = document.getElementById("output");

      document.getElementById("imageInput").addEventListener("change", () => {
        const file = document.getElementById("imageInput").files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          base64ImageData = e.target.result;
          convertImage();
        };
        reader.readAsDataURL(file);
      });

      async function convertImage() {
        // Hide preview elements initially
        zplPreview.classList.add("hidden");
        previewPlaceholder.classList.remove("hidden");
        rulerH.classList.add("hidden");
        rulerV.classList.add("hidden");

        if (!base64ImageData) {
          return;
        }

        const options = {
          width: parseFloat(document.getElementById("width").value),
          height: parseFloat(document.getElementById("height").value),
          format: document.getElementById("format").value,
          rotation: document.getElementById("rotation").value,
          blackThreshold: parseInt(
            document.getElementById("blackThreshold").value
          ),
          darkness: parseInt(document.getElementById("darkness").value),
          noTrim: document.getElementById("noTrim").checked,
        };

        try {
          const zplCode = await convertToZPL(base64ImageData, options);
          output.value = zplCode;

          const inchesWidth = options.width / 2.54;
          const inchesHeight = options.height / 2.54;
          const url = `https://api.labelary.com/v1/printers/8dpmm/labels/${inchesWidth}x${inchesHeight}/0/`;

          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: zplCode,
          });

          if (!response.ok) throw new Error("ZPL render failed");

          const blob = await response.blob();
          zplPreview.src = URL.createObjectURL(blob);

          zplPreview.classList.remove("hidden");
          previewPlaceholder.classList.add("hidden");
          rulerH.classList.remove("hidden");
          rulerV.classList.remove("hidden");

          updateRulers(options.width, options.height);
        } catch (error) {
          console.error("แปลงภาพหรือแสดง preview ไม่สำเร็จ:", error);
          zplPreview.classList.add("hidden");
          previewPlaceholder.classList.remove("hidden");
          rulerH.classList.add("hidden");
          rulerV.classList.add("hidden");
        }
      }

      function updateRulers(widthCm, heightCm) {
        rulerH.innerHTML = "";
        rulerV.innerHTML = "";

        for (let i = 0; i <= widthCm; i++) {
          const tick = document.createElement("div");
          tick.innerText = i + "cm";
          tick.style.flex = "1";
          tick.style.textAlign = "center";
          rulerH.appendChild(tick);
        }

        for (let i = 0; i <= heightCm; i++) {
          const tick = document.createElement("div");
          tick.innerText = i + "cm";
          tick.style.flex = "1";
          tick.style.writingMode = "vertical-rl";
          tick.style.textAlign = "center";
          rulerV.appendChild(tick);
        }
      }
    </script>
  </body>
</html>
